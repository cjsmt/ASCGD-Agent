import subprocess
import json
import os
from langchain.tools import tool
import requests
from typing import Dict, Any

@tool
def security_check_solidity(code: str) -> str:
    """
    Perform a basic security scan on a Solidity smart contract.
    Args:
        code: Solidity contract source code
    Returns:
        A security report string
    """
    try:
        vulnerabilities = []
        
        # Reentrancy heuristic
        if ".call(" in code and "value:" in code:
            if "require(" not in code or "reentrancy" in code.lower():
                vulnerabilities.append("âš ï¸ Possible reentrancy risk: low-level .call used without clear reentrancy protection")
        
        # Integer overflow heuristic
        if "++" in code or "--" in code or "+=" in code or "-=" in code:
            vulnerabilities.append("ðŸ” Consider using SafeMath or Solidity >=0.8.x to avoid integer overflow/underflow")
        
        # Unchecked external calls
        if ".call(" in code or ".delegatecall(" in code or ".send(" in code:
            vulnerabilities.append("ðŸ“ Found external calls. Ensure return values are checked and handled properly")
        
        # Missing access control
        if "onlyOwner" not in code and "require(msg.sender == owner)" not in code:
            if "mint" in code or "burn" in code or "pause" in code:
                vulnerabilities.append("ðŸ” Critical functions may lack access control modifiers")
        
        # Timestamp dependence
        if "block.timestamp" in code:
            vulnerabilities.append("â° Timestamp dependence detected; miners could influence timestamps")
        
        # tx.origin usage
        if "tx.origin" in code:
            vulnerabilities.append("ðŸš¨ tx.origin detected â€” this may lead to phishing-like vulnerabilities")
        
        # Potential uninitialized storage pointer heuristic
        if "struct" in code and "memory" not in code:
            vulnerabilities.append("ðŸ“ Possible uninitialized storage pointer usage detected")
        
        # Build security report
        if not vulnerabilities:
            security_report = "âœ… Security check passed: no obvious issues detected.\n\nRecommendations:\n- Run comprehensive unit tests\n- Consider third-party security audit\n- Test thoroughly on testnets"
        else:
            security_report = "Security scan report:\n\n" + "\n".join(vulnerabilities)
            security_report += "\n\nðŸ”§ Fix recommendations:\n- Use OpenZeppelin libraries where appropriate\n- Add proper access control\n- Write comprehensive tests\n- Consider a professional security audit"
        
        return security_report
        
    except Exception as e:
        return f"Security check error: {str(e)}"

@tool
def analyze_with_slither(code: str) -> str:
    """
    Run Slither static analysis if Slither is installed locally.
    Args:
        code: Solidity source code
    Returns:
        Slither analysis result or error message
    """
    try:
        import subprocess
        import tempfile
        import os
        
        # Create temporary file
        with tempfile.NamedTemporaryFile(mode='w', suffix='.sol', delete=False) as f:
            f.write(code)
            temp_file = f.name
        
        try:
            # Run slither
            result = subprocess.run(
                ['slither', temp_file, '--json', '-'],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            if result.returncode == 0:
                return f"Slither analysis completed:\n{result.stdout}"
            else:
                return f"Slither reported issues:\n{result.stderr}"
                
        except subprocess.TimeoutExpired:
            return "Slither analysis timed out"
        except FileNotFoundError:
            return "Slither not installed. Please install with: pip install slither-analyzer"
        finally:
            # Cleanup temporary file
            os.unlink(temp_file)
            
    except Exception as e:
        return f"Slither analysis failed: {str(e)}"