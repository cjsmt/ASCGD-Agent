# tools/solidity_vulnerability_tool.py
import subprocess
import json
import os
from langchain.tools import tool

@tool
def analyze_solidity_vulnerabilities(source_path: str) -> str:
    """
    使用 Slither 对本地 Solidity 合约进行静态分析。
    返回：简易摘要 + 原始 Slither JSON 报告（或错误信息）
    """
    if not os.path.exists(source_path):
        return f"❌ 文件不存在：{source_path}"

    # Slither 输出临时 json 路径
    out_json = "slither_report.json"
    try:
        # --json 输出到 stdout 也可，但这里写文件更方便
        proc = subprocess.run(
            ["slither", source_path, "--json", out_json, "--solc-remaps", "@openzeppelin=node_modules/@openzeppelin"],
            capture_output=True, text=True, timeout=180
        )
        # Slither 在某些情况下仍会返回 exit 0，但写入 report 文件
        if proc.returncode != 0 and not os.path.exists(out_json):
            return f"❌ Slither 分析失败：{proc.stderr.strip()}"

        # 读取 JSON 报告（若存在）
        if os.path.exists(out_json):
            with open(out_json, "r", encoding="utf-8") as f:
                report_json = json.load(f)
            # 从 JSON 中提取关键问题（示例）
            findings = []
            if isinstance(report_json, dict):
                for item in report_json.get("results", {}).get("detectors", []):
                    # detector 里会有更多结构，下面是通用抓取
                    name = item.get("name", "unknown")
                    desc = item.get("description", "") or item.get("notes", "")
                    findings.append(f"{name}: {desc}")
            summary = {
                "total_findings": len(findings),
                "findings": findings[:20]  # 只展示前20项
            }
            return f"✅ Slither 分析完成。\n摘要: {json.dumps(summary, ensure_ascii=False, indent=2)}\n\n原始报告(部分):\n{json.dumps(report_json, ensure_ascii=False)[:8000]}"
        else:
            return f"⚠️ Slither 没有产生 JSON 报告，但没有返回错误。stdout: {proc.stdout[:1000]}"
    except FileNotFoundError:
        return ("❌ 未找到 slither 可执行程序。请先安装 Slither（参见 README）。\n"
                "通常：pip install slither-analyzer（并确保 solc 可用）")
    except subprocess.TimeoutExpired:
        return "⏰ Slither 分析超时（>180s）。请检查合约复杂度或本机性能。"
    except Exception as e:
        return f"⚠️ 分析异常：{str(e)}"
